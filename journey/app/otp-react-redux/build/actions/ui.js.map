{"version":3,"sources":["ui.js"],"names":["routeTo","url","replaceSearch","routingMethod","push","dispatch","getState","router","search","location","window","path","matchContentToUrl","root","pathname","split","match","exact","strict","id","params","routeId","setViewedRoute","setMainPanelContent","MainPanelContent","ROUTE_VIEWER","setViewedStop","stopId","STOP_VIEWER","lat","lon","zoom","routerId","idToParams","console","log","delimiter","map","s","isNaN","handleBackButtonPress","e","otpState","otp","activeSearchId","uiUrlParams","urlParams","coreUtils","query","getUrlParams","previousSearchId","ui_activeSearch","previousItinIndex","ui_activeItinerary","previousSearch","searches","index","type","warn","setMobileScreen","payload","ui","mainPanelContent","setPanel","viewRoute","viewStop","setViewedTrip","clearPanel","toggleAutoRefresh","MobileScreens","WELCOME_SCREEN","SET_INITIAL_LOCATION","SEARCH_FORM","SET_FROM_LOCATION","SET_TO_LOCATION","SET_OPTIONS","SET_DATETIME","RESULTS_SUMMARY"],"mappings":"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","sourcesContent":["import { push } from 'connected-react-router'\nimport coreUtils from '../otp-ui/core-utils/src'\nimport { createAction } from 'redux-actions'\nimport { matchPath } from 'react-router'\n\nimport { findRoute } from './api'\nimport { setMapCenter, setMapZoom, setRouterId } from './config'\nimport { clearActiveSearch, parseUrlQueryString, setActiveSearch } from './form'\nimport { clearLocation } from './map'\nimport { setActiveItinerary } from './narrative'\nimport { getUiUrlParams } from '../util/state'\n\n/**\n * Wrapper function for history#push (or, if specified, replace, etc.)\n * that preserves the current search or, if\n * replaceSearch is provided (including an empty string), replaces the search\n * when routing to a new URL path.\n * @param  {[type]} url           path to route to\n * @param  {string} replaceSearch optional search string to replace current one\n * @param  {func}   routingMethod the connected-react-router method to execute (defaults to push).\n */\nexport function routeTo (url, replaceSearch, routingMethod = push) {\n  return function (dispatch, getState) {\n    // Get search to preserve when routing to new path.\n    const { router } = getState()\n    const search = router ? router.location.search : window.location.search\n    let path = url\n    if (replaceSearch || replaceSearch === '') {\n      path = `${path}${replaceSearch}`\n    } else {\n      path = `${path}${search}`\n    }\n    dispatch(routingMethod(path))\n  }\n}\n\n/**\n * Checks URL and redirects app to appropriate content (e.g., viewed\n * route or stop).\n */\nexport function matchContentToUrl (location) {\n  return function (dispatch, getState) {\n    // This is a bit of a hack to make up for the fact that react-router does\n    // not always provide the match params as expected.\n    // https://github.com/ReactTraining/react-router/issues/5870#issuecomment-394194338\n    const root = location.pathname.split('/')[1]\n    const match = matchPath(location.pathname, {\n      path: `/${root}/:id`,\n      exact: true,\n      strict: false\n    })\n    const id = match && match.params && match.params.id\n    switch (root) {\n      case 'route':\n        if (id) {\n          dispatch(findRoute({ routeId: id }))\n          dispatch(setViewedRoute({ routeId: id }))\n        } else {\n          dispatch(setViewedRoute(null))\n          dispatch(setMainPanelContent(MainPanelContent.ROUTE_VIEWER))\n        }\n        break\n      case 'stop':\n        if (id) {\n          dispatch(setViewedStop({ stopId: id }))\n        } else {\n          dispatch(setViewedStop(null))\n          dispatch(setMainPanelContent(MainPanelContent.STOP_VIEWER))\n        }\n        break\n      case 'start':\n      case '@':\n        // Parse comma separated params (ensuring numbers are parsed correctly).\n        let [lat, lon, zoom, routerId] = id ? idToParams(id) : []\n        if (!lat || !lon) {\n          // Attempt to parse path if lat/lon not found. (Legacy UI otp.js used\n          // slashes in the pathname to specify lat, lon, etc.)\n          [,, lat, lon, zoom, routerId] = idToParams(location.pathname, '/')\n        }\n        console.log(lat, lon, zoom, routerId)\n        // Update map location/zoom and optionally override router ID.\n        if (+lat && +lon) dispatch(setMapCenter({ lat, lon }))\n        if (+zoom) dispatch(setMapZoom({ zoom }))\n        // If router ID is provided, override the default routerId.\n        if (routerId) dispatch(setRouterId(routerId))\n        dispatch(setMainPanelContent(null))\n        break\n      // For any other route path, just revert to default panel.\n      default:\n        dispatch(setMainPanelContent(null))\n        break\n    }\n  }\n}\n\n/**\n * Split the path id into its parts (according to specified delimiter). Parse\n * numbers if detected.\n */\nfunction idToParams (id, delimiter = ',') {\n  return id.split(delimiter).map(s => isNaN(s) ? s : +s)\n}\n\n/**\n * Event listener for responsive webapp that handles a back button press and\n * sets the active search and itinerary according to the URL query params.\n */\nexport function handleBackButtonPress (e) {\n  return function (dispatch, getState) {\n    const otpState = getState().otp\n    const { activeSearchId } = otpState\n    const uiUrlParams = getUiUrlParams(otpState)\n    // Get new search ID from URL after back button pressed.\n    // console.log('back button pressed', e)\n    const urlParams = coreUtils.query.getUrlParams()\n    const previousSearchId = urlParams.ui_activeSearch\n    const previousItinIndex = +urlParams.ui_activeItinerary || 0\n    const previousSearch = otpState.searches[previousSearchId]\n    if (previousSearch) {\n      // If back button pressed and active search has changed, set search to\n      // previous search ID.\n      if (activeSearchId !== previousSearchId) {\n        dispatch(setActiveSearch(previousSearchId))\n      } else if (uiUrlParams.ui_activeItinerary !== previousItinIndex) {\n        // Active itinerary index has changed.\n        dispatch(setActiveItinerary({ index: previousItinIndex }))\n      }\n    } else {\n      // The back button was pressed, but there was no corresponding search\n      // found for the previous search ID. Derive search from URL params.\n      if (!previousSearchId && activeSearchId) {\n        // There is no search ID. Clear active search and from/to\n        dispatch(clearActiveSearch())\n        dispatch(clearLocation({ type: 'from' }))\n        dispatch(clearLocation({ type: 'to' }))\n      } else if (previousSearchId) {\n        console.warn(`No search found in state history for search ID: ${previousSearchId}. Replanning...`)\n        // Set query to the params found in the URL and perform routing query\n        // for search ID.\n        // Also, we don't want to update the URL here because that will funk with\n        // the browser history.\n        dispatch(parseUrlQueryString(urlParams))\n      }\n    }\n  }\n}\n\nexport const setMobileScreen = createAction('SET_MOBILE_SCREEN')\n\n/**\n * Sets the main panel content according to the payload (one of the enum values\n * of MainPanelContent) and routes the application to the correct path.\n * @param {number} payload MainPanelContent value\n */\nexport function setMainPanelContent (payload) {\n  return function (dispatch, getState) {\n    const { otp, router } = getState()\n    if (otp.ui.mainPanelContent === payload) {\n      console.warn(`Attempt to route from ${otp.ui.mainPanelContent} to ${payload}. Doing nothing`)\n      // Do nothing if the panel is already set. This will guard against over\n      // enthusiastic routing and overwriting current/nested states.\n      return\n    }\n    dispatch(setPanel(payload))\n    switch (payload) {\n      case MainPanelContent.ROUTE_VIEWER:\n        dispatch(routeTo('/route'))\n        break\n      case MainPanelContent.STOP_VIEWER:\n        dispatch(routeTo('/stop'))\n        break\n      default:\n        // Clear route, stop, and trip viewer focus and route to root\n        dispatch(viewRoute(null))\n        dispatch(viewStop(null))\n        dispatch(setViewedTrip(null))\n        if (router.location.pathname !== '/') dispatch(routeTo('/'))\n        break\n    }\n  }\n}\n\nconst setPanel = createAction('SET_MAIN_PANEL_CONTENT')\nexport const clearPanel = createAction('CLEAR_MAIN_PANEL')\n\n// Stop/Route/Trip Viewer actions\n\nexport function setViewedStop (payload) {\n  return function (dispatch, getState) {\n    dispatch(viewStop(payload))\n    const path = payload && payload.stopId\n      ? `/stop/${payload.stopId}`\n      : '/stop'\n    dispatch(routeTo(path))\n  }\n}\n\nconst viewStop = createAction('SET_VIEWED_STOP')\n\nexport const setViewedTrip = createAction('SET_VIEWED_TRIP')\n\nexport function setViewedRoute (payload) {\n  return function (dispatch, getState) {\n    dispatch(viewRoute(payload))\n    const path = payload && payload.routeId\n      ? `/route/${payload.routeId}`\n      : '/route'\n    dispatch(routeTo(path))\n  }\n}\n\nconst viewRoute = createAction('SET_VIEWED_ROUTE')\n\nexport const toggleAutoRefresh = createAction('TOGGLE_AUTO_REFRESH')\n\n// UI state enums\n\nexport const MainPanelContent = {\n  ROUTE_VIEWER: 1,\n  STOP_VIEWER: 2\n}\n\nexport const MobileScreens = {\n  WELCOME_SCREEN: 1,\n  SET_INITIAL_LOCATION: 2,\n  SEARCH_FORM: 3,\n  SET_FROM_LOCATION: 4,\n  SET_TO_LOCATION: 5,\n  SET_OPTIONS: 6,\n  SET_DATETIME: 7,\n  RESULTS_SUMMARY: 8\n}\n"]}