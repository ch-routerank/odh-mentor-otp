{"version":3,"sources":["bounds-updating-overlay.js"],"names":["extendBoundsByPlaces","bounds","places","filter","place","forEach","coords","lat","lon","coreUtils","map","isValidLatLng","extend","BoundsUpdatingOverlay","updateBounds","props","prevProps","oldProps","newProps","popupLocation","leaflet","padding","newFrom","query","from","newItinBounds","itinerary","newTo","to","oldFrom","oldItinBounds","oldTo","fromChanged","toChanged","oldIntermediate","intermediatePlaces","newIntermediate","intermediateChanged","equals","fitBounds","activeLeg","legs","ui","isMobile","L","getBottomLeft","left","x","bottom","y","getTopRight","right","top","panTo","getBounds","activeStep","leg","step","steps","MapLayer","mapStateToProps","state","ownProps","activeSearch","otp","mapPopupLocation","currentQuery","mapDispatchToProps"],"mappings":"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","sourcesContent":["import isEqual from 'lodash.isequal'\nimport coreUtils from '@opentripplanner/core-utils'\nimport L from 'leaflet'\nimport { MapLayer, withLeaflet } from 'react-leaflet'\nimport { connect } from 'react-redux'\n\nimport {\n  getLeafletItineraryBounds,\n  getLeafletLegBounds\n} from '../../util/itinerary'\nimport { getActiveItinerary, getActiveSearch } from '../../util/state'\n\n/**\n * Utility to extend input Leaflet bounds to include the list of places.\n */\nfunction extendBoundsByPlaces (bounds, places = []) {\n  places\n    .filter(place => place)\n    .forEach(place => {\n      const coords = [place.lat, place.lon]\n      if (coreUtils.map.isValidLatLng(coords)) bounds.extend(coords)\n    })\n}\n\n/**\n * This MapLayer component will automatically update the leaflet bounds\n * depending on what data is in the redux store. This component does not\n * \"render\" anything on the map.\n */\nclass BoundsUpdatingOverlay extends MapLayer {\n  createLeafletElement () {}\n\n  updateLeafletElement () {}\n\n  componentDidMount () {\n    this.updateBounds(null, this.props)\n  }\n\n  componentDidUpdate (prevProps) {\n    this.updateBounds(prevProps, this.props)\n  }\n\n  componentWillUnmount () {}\n\n  /* eslint-disable-next-line complexity */\n  updateBounds (oldProps, newProps) {\n    // TODO: maybe setting bounds ought to be handled in map props...\n\n    oldProps = oldProps || {}\n    newProps = newProps || {}\n\n    // Don't auto-fit if popup us active\n    if (oldProps.popupLocation || newProps.popupLocation) return\n\n    const { map } = newProps.leaflet\n    if (!map) return\n\n    const padding = [30, 30]\n\n    // Fit map to to entire itinerary if active itinerary bounds changed\n    const newFrom = newProps.query && newProps.query.from\n    const newItinBounds = newProps.itinerary && getLeafletItineraryBounds(newProps.itinerary)\n    const newTo = newProps.query && newProps.query.to\n    const oldFrom = oldProps.query && oldProps.query.from\n    const oldItinBounds = oldProps.itinerary && getLeafletItineraryBounds(oldProps.itinerary)\n    const oldTo = oldProps.query && oldProps.query.to\n    const fromChanged = !isEqual(oldFrom, newFrom)\n    const toChanged = !isEqual(oldTo, newTo)\n    const oldIntermediate = oldProps.query && oldProps.query.intermediatePlaces\n    const newIntermediate = newProps.query && newProps.query.intermediatePlaces\n    const intermediateChanged = !isEqual(oldIntermediate, newIntermediate)\n    if (\n      (!oldItinBounds && newItinBounds) ||\n      (oldItinBounds && newItinBounds && !oldItinBounds.equals(newItinBounds))\n    ) {\n      map.fitBounds(newItinBounds, { padding })\n    // Pan to to itinerary leg if made active (clicked); newly active leg must be non-null\n    } else if (\n      newProps.itinerary &&\n        newProps.activeLeg !== oldProps.activeLeg &&\n        newProps.activeLeg !== null\n    ) {\n      map.fitBounds(\n        getLeafletLegBounds(newProps.itinerary.legs[newProps.activeLeg]),\n        { padding }\n      )\n\n    // If no itinerary update but from/to locations are present, fit to those\n    } else if (newFrom && newTo && (fromChanged || toChanged)) {\n      // On certain mobile devices (e.g., Android + Chrome), setting from and to\n      // locations via the location search component causes issues for this\n      // fitBounds invocation. The map does not appear to be visible when these\n      // prop changes are detected, so for now we should perhaps just skip this\n      // fitBounds on mobile.\n      // See https://github.com/opentripplanner/otp-react-redux/issues/133 for\n      // more info.\n      // TODO: Fix this so mobile devices will also update the bounds to the\n      // from/to locations.\n      if (!coreUtils.ui.isMobile()) {\n        const bounds = L.bounds([\n          [newFrom.lat, newFrom.lon],\n          [newTo.lat, newTo.lon]\n        ])\n        // Ensure bounds extend to include intermediatePlaces\n        extendBoundsByPlaces(bounds, newIntermediate)\n        const { x: left, y: bottom } = bounds.getBottomLeft()\n        const { x: right, y: top } = bounds.getTopRight()\n        map.fitBounds([\n          [left, bottom],\n          [right, top]\n        ], { padding })\n      }\n\n    // If only from or to is set, pan to that\n    } else if (newFrom && fromChanged) {\n      map.panTo([newFrom.lat, newFrom.lon])\n    } else if (newTo && toChanged) {\n      map.panTo([newTo.lat, newTo.lon])\n\n    // If intermediate place is added, extend bounds.\n    } else if (newIntermediate && intermediateChanged) {\n      const bounds = map.getBounds()\n      extendBoundsByPlaces(bounds, newIntermediate)\n      map.fitBounds(bounds)\n\n    // Pan to to itinerary step if made active (clicked)\n    } else if (\n      newProps.itinerary &&\n      newProps.activeLeg !== null &&\n      newProps.activeStep !== null &&\n      newProps.activeStep !== oldProps.activeStep\n    ) {\n      const leg = newProps.itinerary.legs[newProps.activeLeg]\n      const step = leg.steps[newProps.activeStep]\n      map.panTo([step.lat, step.lon])\n    }\n  }\n}\n\n// connect to the redux store\n\nconst mapStateToProps = (state, ownProps) => {\n  const activeSearch = getActiveSearch(state.otp)\n  return {\n    activeLeg: activeSearch && activeSearch.activeLeg,\n    activeStep: activeSearch && activeSearch.activeStep,\n    itinerary: getActiveItinerary(state.otp),\n    popupLocation: state.otp.ui.mapPopupLocation,\n    query: state.otp.currentQuery\n  }\n}\n\nconst mapDispatchToProps = {}\n\nexport default withLeaflet(\n  connect(mapStateToProps, mapDispatchToProps)(BoundsUpdatingOverlay)\n)\n"]}