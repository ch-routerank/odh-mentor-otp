{"version":3,"sources":["default-map.js"],"names":["MapContainer","styled","div","DefaultMap","oldQuery","newQuery","overlays","props","mode","oldModes","split","newModes","removed","filter","m","includes","added","overlayVisibility","oConfig","modes","length","overlayMode","companies","overlayCompany","name","Object","keys","updateOverlayVisibility","e","setMapPopupLocationAndGeocode","setMapPopupLocation","location","payload","setLocation","prevProps","_handleQueryChange","query","bikeRentalQuery","bikeRentalStations","carRentalQuery","carRentalStations","mapConfig","mapPopupLocation","vehicleRentalQuery","vehicleRentalStations","center","initLat","initLon","popup","contents","onSetLocationFromPopup","lat","lon","baseLayers","maxZoom","onMapClick","onPopupClosed","initZoom","map","overlayConfig","k","type","Component","mapStateToProps","state","ownProps","otp","config","overlay","bikeRental","stations","carRental","ui","currentQuery","vehicleRental","mapDispatchToProps"],"mappings":"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","sourcesContent":["import BaseMap from '@opentripplanner/base-map'\nimport React, { Component } from 'react'\nimport { connect } from 'react-redux'\nimport styled from 'styled-components'\n\nimport {\n  bikeRentalQuery,\n  carRentalQuery,\n  vehicleRentalQuery\n} from '../../actions/api'\nimport { updateOverlayVisibility } from '../../actions/config'\nimport {\n  setLocation,\n  setMapPopupLocation,\n  setMapPopupLocationAndGeocode\n} from '../../actions/map'\nimport BoundsUpdatingOverlay from './bounds-updating-overlay'\nimport EndpointsOverlay from './connected-endpoints-overlay'\nimport ParkAndRideOverlay from './connected-park-and-ride-overlay'\nimport RouteViewerOverlay from './connected-route-viewer-overlay'\nimport StopViewerOverlay from './connected-stop-viewer-overlay'\nimport StopsOverlay from './connected-stops-overlay'\nimport TransitiveOverlay from './connected-transitive-overlay'\nimport TripViewerOverlay from './connected-trip-viewer-overlay'\nimport VehicleRentalOverlay from './connected-vehicle-rental-overlay'\nimport ElevationPointMarker from './elevation-point-marker'\nimport PointPopup from './point-popup'\nimport TileOverlay from './tile-overlay'\nimport ZipcarOverlay from './zipcar-overlay'\n\nconst MapContainer = styled.div`\n  height: 100%;\n  width: 100%;\n\n  .map {\n    height: 100%;\n    width: 100%;\n  }\n\n  * {\n    box-sizing: unset;\n  }\n`\n\nclass DefaultMap extends Component {\n  /**\n   * Checks whether the modes have changed between old and new queries and\n   * whether to update the map overlays accordingly (e.g., to show rental vehicle\n   * options on the map).\n   */\n  _handleQueryChange = (oldQuery, newQuery) => {\n    const { overlays } = this.props\n    if (overlays && oldQuery.mode) {\n      // Determine any added/removed modes\n      const oldModes = oldQuery.mode.split(',')\n      const newModes = newQuery.mode.split(',')\n      const removed = oldModes.filter(m => !newModes.includes(m))\n      const added = newModes.filter(m => !oldModes.includes(m))\n      const overlayVisibility = {}\n      for (const oConfig of overlays) {\n        if (!oConfig.modes || oConfig.modes.length !== 1) continue\n        // TODO: support multi-mode overlays\n        const overlayMode = oConfig.modes[0]\n\n        if (\n          (\n            overlayMode === 'CAR_RENT' ||\n            overlayMode === 'CAR_HAIL' ||\n            overlayMode === 'MICROMOBILITY_RENT'\n          ) &&\n          oConfig.companies\n        ) {\n          // Special handling for company-based mode overlays (e.g. carshare, car-hail)\n          const overlayCompany = oConfig.companies[0] // TODO: handle multi-company overlays\n          if (added.includes(overlayMode)) {\n            // Company-based mode was just selected; enable overlay iff overlay's company is active\n            if (newQuery.companies.includes(overlayCompany)) overlayVisibility[oConfig.name] = true\n          } else if (removed.includes(overlayMode)) {\n            // Company-based mode was just deselected; disable overlay (regardless of company)\n            overlayVisibility[oConfig.name] = false\n          } else if (newModes.includes(overlayMode) && oldQuery.companies !== newQuery.companies) {\n            // Company-based mode remains selected but companies change\n            overlayVisibility[oConfig.name] = newQuery.companies.includes(overlayCompany)\n          }\n        } else { // Default handling for other modes\n          if (added.includes(overlayMode)) overlayVisibility[oConfig.name] = true\n          if (removed.includes(overlayMode)) overlayVisibility[oConfig.name] = false\n        }\n      }\n      // Only trigger update action if there are overlays to update.\n      if (Object.keys(overlayVisibility).length > 0) {\n        this.props.updateOverlayVisibility(overlayVisibility)\n      }\n    }\n  }\n\n  onMapClick = (e) => {\n    this.props.setMapPopupLocationAndGeocode(e)\n  }\n\n  onPopupClosed = () => {\n    this.props.setMapPopupLocation({ location: null })\n  }\n\n  onSetLocationFromPopup = (payload) => {\n    const { setLocation, setMapPopupLocation } = this.props\n    setMapPopupLocation({ location: null })\n    setLocation(payload)\n  }\n\n  componentDidUpdate (prevProps) {\n    // Check if any overlays should be toggled due to mode change\n    this._handleQueryChange(prevProps.query, this.props.query)\n  }\n\n  render () {\n    const {\n      bikeRentalQuery,\n      bikeRentalStations,\n      carRentalQuery,\n      carRentalStations,\n      mapConfig,\n      mapPopupLocation,\n      vehicleRentalQuery,\n      vehicleRentalStations\n    } = this.props\n\n    const center = mapConfig && mapConfig.initLat && mapConfig.initLon\n      ? [mapConfig.initLat, mapConfig.initLon]\n      : null\n\n    const popup = mapPopupLocation && {\n      contents: (\n        <PointPopup\n          mapPopupLocation={mapPopupLocation}\n          onSetLocationFromPopup={this.onSetLocationFromPopup}\n        />\n      ),\n      location: [mapPopupLocation.lat, mapPopupLocation.lon]\n    }\n\n    return (\n      <MapContainer>\n        <BaseMap\n          baseLayers={mapConfig.baseLayers}\n          center={center}\n          maxZoom={mapConfig.maxZoom}\n          onClick={this.onMapClick}\n          popup={popup}\n          onPopupClosed={this.onPopupClosed}\n          zoom={mapConfig.initZoom || 13}\n        >\n          {/* The default overlays */}\n          <BoundsUpdatingOverlay />\n          <EndpointsOverlay />\n          <RouteViewerOverlay />\n          <StopViewerOverlay />\n          <TransitiveOverlay />\n          <TripViewerOverlay />\n          <ElevationPointMarker />\n\n          {/* The configurable overlays */}\n          {mapConfig.overlays && mapConfig.overlays.map((overlayConfig, k) => {\n            switch (overlayConfig.type) {\n              case 'bike-rental': return (\n                <VehicleRentalOverlay\n                  key={k}\n                  {...overlayConfig}\n                  refreshVehicles={bikeRentalQuery}\n                  stations={bikeRentalStations}\n                />\n              )\n              case 'car-rental': return (\n                <VehicleRentalOverlay\n                  key={k}\n                  {...overlayConfig}\n                  refreshVehicles={carRentalQuery}\n                  stations={carRentalStations}\n                />\n              )\n              case 'park-and-ride':\n                return <ParkAndRideOverlay key={k} {...overlayConfig} />\n              case 'stops': return <StopsOverlay key={k} {...overlayConfig} />\n              case 'tile': return <TileOverlay key={k} {...overlayConfig} />\n              case 'micromobility-rental': return (\n                <VehicleRentalOverlay\n                  key={k}\n                  {...overlayConfig}\n                  refreshVehicles={vehicleRentalQuery}\n                  stations={vehicleRentalStations}\n                />\n              )\n              case 'zipcar': return <ZipcarOverlay key={k} {...overlayConfig} />\n              default: return null\n            }\n          })}\n        </BaseMap>\n      </MapContainer>\n    )\n  }\n}\n\n// connect to the redux store\n\nconst mapStateToProps = (state, ownProps) => {\n  const overlays = state.otp.config.map && state.otp.config.map.overlays\n    ? state.otp.config.map.overlays\n    : []\n  return {\n    bikeRentalStations: state.otp.overlay.bikeRental.stations,\n    carRentalStations: state.otp.overlay.carRental.stations,\n    mapConfig: state.otp.config.map,\n    mapPopupLocation: state.otp.ui.mapPopupLocation,\n    overlays,\n    query: state.otp.currentQuery,\n    vehicleRentalStations: state.otp.overlay.vehicleRental.stations\n  }\n}\n\nconst mapDispatchToProps = {\n  bikeRentalQuery,\n  carRentalQuery,\n  setLocation,\n  setMapPopupLocation,\n  setMapPopupLocationAndGeocode,\n  updateOverlayVisibility,\n  vehicleRentalQuery\n}\n\nexport default connect(mapStateToProps, mapDispatchToProps)(DefaultMap)\n"]}